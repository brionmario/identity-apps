# This workflow will build PRs submitted to the master branch.

name: PR Builder

on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]
        maven-version: [3.6.3]
    env:
      CHANGED_FILES: $(git log --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.after }} | sort -u)

    steps:
    - name: Checkout
      id: checkout
      uses: actions/checkout@v2.3.3
      with:
        fetch-depth: 0
    - name: Use Node.js ${{ matrix.node-version }}
      id: node-setup
      uses: actions/setup-node@v2.1.2
      with:
        node-version: ${{ matrix.node-version }}
    - name: Set up JDK 1.8
      id: jdk-setup
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Set up Maven
      uses: stCarolas/setup-maven@v4
      id: mvn-setup
      with:
        maven-version: ${{ matrix.maven-version }}
    - name: Get npm cache directory
      id: cache-npm-modules
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Cache local Maven repository
      id: cache-maven-m2
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Build
      id: build-with-maven
      run: |
        URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${{ github.event.pull_request.number }}/files"
        FILES=$(curl -s -X GET -G $URL | jq -r '.[] | .filename')
        echo "join($FILES, ', ')"
        echo "$FILES" >> $GITHUB_PATH
        echo "${{toJson(env)}}"
        mvn clean install -U -Dlint.exec.skip=false -Dlint.exec.pattern="join($FILES, ', ')"

